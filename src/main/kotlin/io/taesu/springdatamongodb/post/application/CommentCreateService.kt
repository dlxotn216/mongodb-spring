package io.taesu.springdatamongodb.post.application

import com.mongodb.BasicDBObject
import io.taesu.springdatamongodb.post.domain.Comment
import io.taesu.springdatamongodb.post.interfaces.dtos.CommentCreateRequest
import org.bson.types.ObjectId
import org.springframework.data.mongodb.core.MongoTemplate
import org.springframework.data.mongodb.core.query.Criteria
import org.springframework.data.mongodb.core.query.Query
import org.springframework.data.mongodb.core.query.Update
import org.springframework.stereotype.Service


/**
 * Created by itaesu on 2024/02/15.
 *
 * @author Lee Tae Su
 * @version spring-data-mongodb
 * @since spring-data-mongodb
 */
@Service
class CommentCreateService(
    private val mongoTemplate: MongoTemplate,
) {
    /**
     * Calling update using query: { "_id" : { "$oid" : "65cf56c1e726c806031a6943"}} and
     * update: { "$push" : { "comments" : { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"},
     * "otherComments" : [{ "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}],
     * "queuedComments" : { "$each" : [{ "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}, { "content" : "content", "author" : "author", "_class" : "io.taesu.springdatamongodb.post.domain.Comment"}], "$sort" : -1, "$slice" : 5}}} in collection: posts
     */
    fun create(postId: String, request: CommentCreateRequest) {
        val query = Query().apply {
            addCriteria(Criteria.where("_id").`is`(ObjectId(postId)))
        }
        val update = Update().apply {
            push("comments", request.toDocument())
            push("otherComments", listOf(request.toDocument(), request.toDocument()))
            push(
                "queuedComments", BasicDBObject("\$each", (1..100).map { request.toDocument() })
                    .append("\$sort", -1)
                    .append("\$slice", 5)
            )
        }
        mongoTemplate.updateFirst(query, update, "posts")
    }
}

fun CommentCreateRequest.toDocument() = Comment(
    author = this.author,
    content = this.content
)
